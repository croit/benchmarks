#!/usr/bin/perl
# compares to result.csv files generated by croit-bench outputs a file containing
# the scale of second/first and the absolute difference


use warnings;
use strict;

use JSON;
use Scalar::Util qw(reftype);
use Data::Dumper qw(Dumper);

my $outfilename = 'benchdiff.csv';
my $csv1 = shift;
my $csv2 = shift;

die "usage: $0 <csv1> <csv2>\n" if (!defined($csv1) || !defined($csv2));

sub compare {
    my ($csv1, $csv2) = @_;

    open(my $fh1, '<:encoding(UTF-8)', "$csv1") ||
	die "Could not open file '$csv1' $!";
    open(my $fh2, '<:encoding(UTF-8)', "$csv2") ||
	die "Could not open file '$csv2' $!";
    open(my $outfh, '>:encoding(UTF-8)', "$outfilename") ||
	die "Could not open file '$outfilename' $!";

    #print the job-description lines from the first document, cosume from both
    my $header_lines = 7;
    my ($lin1, $lin2, $i);

    for ($i = 0; $i < $header_lines; $i++) {
	$lin1 = <$fh1>;
	$lin2 = <$fh2>;

	print $outfh "$lin1";
    }

    # for the remaining lines write the difference
    my ($label, $res);
    my ($cell1, $cell2, $diff, $perc);
    my (@cells1, @cells2);
    while ($lin1 = <$fh1>) {
	$lin2 = <$fh2>;

	chomp($lin1, $lin2);
	@cells1 = split("\t", $lin1);
	@cells2 = split("\t", $lin2);

	$res = shift @cells1;


	shift @cells2;

	foreach $cell1 (@cells1) {
	    $cell2 = shift @cells2;

	    $diff = $cell1 - $cell2;
	    if ($cell1 == 0){
		$perc = 0;
	    } else {
		$perc = $cell2 / $cell1 * 100;
	    }

	    $res .= sprintf("\t%.2f (%d)" , $perc, $diff);

	}
	print $outfh "$res\n";
    }
    close($fh1);
    close($fh2);
    close($outfh);

}

compare($csv1, $csv2);

